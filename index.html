<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Web3Final</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.min.js"></script>
</head>
<body>
    <script>
        //Todd Vogel created this game.
        var BootScene = new Phaser.Class({
        
            Extends: Phaser.Scene,

            initialize:

            function BootScene ()
            {
                Phaser.Scene.call(this, { key: 'BootScene' });
            },

            preload: function ()
            {
                // load the resources here
                // map tiles
                this.load.image('tiles', 'assets/Map/spritesheet.png');
                
                // map in json format
                this.load.tilemapTiledJSON('map', 'assets/Map/Map1.json');

                //Load start screen image
                this.load.image('start', 'assets/sky.png');

                // our character + other random characters we probably won't use
                this.load.spritesheet('player', 'assets/sprites32x32.png', { frameWidth: 32, frameHeight: 32 });
                //Load small enemies
                this.load.spritesheet("rat","assets/Small/rat.png", {frameWidth: 64, frameHeight: 64});
                this.load.spritesheet("dune", "assets/Small/dune_crawler.png", {frameWidth: 64, frameHeight: 64});
                this.load.spritesheet("slime", "assets/Small/green_slime.png", {frameWidth: 64, frameHeight: 64});
                this.load.spritesheet("scorpion", "assets/Small/scorpion.png", {frameWidth: 64, frameHeight: 64});
                this.load.spritesheet("spider", "assets/Small/spider.png", {frameWidth: 64, frameHeight: 64});
                //Load medium enemies
                this.load.spritesheet("bat", "assets/Medium/bat.png", {frameWidth: 128, frameHeight: 128});
                this.load.spritesheet("demon", "assets/Medium/demon.png", {frameWidth: 128, frameHeight: 192});
                this.load.spritesheet("skeleton", "assets/Medium/skeleton.png", {frameWidth: 64, frameHeight: 128});
                this.load.spritesheet("snake", "assets/Medium/snake.png", {frameWidth: 128, frameHeight: 64});
                this.load.spritesheet("tree", "assets/Medium/tree.png", {frameWidth:128, frameHeight: 128});
                //Load large enemies
                this.load.spritesheet("deceleon", "assets/Large/deceleon.png", {frameWidth: 256, frameHeight: 256});
                this.load.spritesheet("drake", "assets/Large/drake.png", {frameWidth: 192, frameHeight: 256});
                this.load.spritesheet("horror", "assets/Large/horror.png", {frameWidth: 192, frameHeight: 192});
                this.load.spritesheet("lizard", "assets/Large/lizard.png", {frameWidth: 192, frameHeight: 192});
                this.load.spritesheet("nagaruda", "assets/Large/nagaruda.png", {frameWidth: 192, frameHeight: 256});
                //Load Boss
                this.load.spritesheet("aurum", "assets/Large/aurum.png", {frameWidth: 320, frameHeight: 256});
                //Load Music
                this.load.audio("Start", "assets/Music/Start.ogg");
                this.load.audio("World", "assets/Music/World.ogg");
                this.load.audio("Battle", "assets/Music/Battle.ogg");
                this.load.audio("Boss", "assets/Music/Boss.ogg");
                this.load.audio("GameOver", "assets/Music/GameOver.ogg");
                //Load SFX
                this.load.audio("Attack", "assets/SFX/attack.wav");
                this.load.audio("Spell", "assets/SFX/spell.wav");
                this.load.audio("Select", "assets/SFX/select.wav");
                this.load.audio("Confirm", "assets/SFX/confirm.wav");
                this.load.audio("Back", "assets/SFX/back.wav");
            },

            create: function ()
            {
                this.cameras.main.flash(2000); //Nice visual effect on load up.
                this.soundFX = this.sound.add("Start", {loop: "true"}); //Set up start screen music
                this.soundFX.setVolume(0.5);
                this.soundFX.play(); //Play music
                this.cameras.main.setBackgroundColor('rgba(0, 200, 0, 0.5)'); //Set color to represent the ground, similar to the battle scene.
                this.add.image(0, 0, 'start').setOrigin(0,0); //Sky image for nicer looking background.
                this.add.text(80, 200, "Web 3 Project", {fontSize: '60px', fill: "#0b1f01"}); //Generic title text
                this.add.text(100, 300, "Press any key to start.", {fontSize: '30px', fill: "#0b1f01"}); //Inform player how to start
                this.input.keyboard.on('keydown', this.fade, this); //Begin on any button pressed
            },
            fade: function() { //First, we fade out slowly, then call the function that starts the game.
                this.cameras.main.fadeOut(1000);
                var wait = this.time.addEvent({delay: 1000, callback: this.startGame, callbackScope: this});
            },
            startGame: function() {
                this.soundFX.stop(); //Stop intro music so music does not overlap.
                this.scene.start('WorldScene'); //Start world map screen.
            }
        });

        var WorldScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

            function WorldScene ()
            {
                Phaser.Scene.call(this, { key: 'WorldScene' });
            },
            preload: function ()
            {
                
            },
            create: function ()
            {
                this.cameras.main.fadeIn(500); //Visual effects again
                this.soundFX = this.sound.add("World", {loop: "true"}); //Music again
                this.soundFX.setVolume(0.5);
                this.soundFX.play();
                // create world
                var map = this.make.tilemap({ key: 'map' });

                var tiles = map.addTilesetImage('spritesheet', 'tiles'); //Lets the game understand the map
                        
                var background = map.createStaticLayer('Background', tiles, 0, 0); //Creating layers based on the layers in the map file
                var obstacles = map.createStaticLayer('Blocked', tiles, 0, 0);
                obstacles.setCollisionByExclusion([-1]); //Make sure player can't just walk through walls.

                this.player = this.physics.add.sprite(550, 550, 'player', 97); //Player sprite

                this.physics.world.bounds.width = map.widthInPixels; //Map borders
                this.physics.world.bounds.height = map.heightInPixels;
                this.player.setCollideWorldBounds(true); //No walking outside of the world. 

                this.cursors = this.input.keyboard.createCursorKeys(); //Allow input for later

                this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels); //Set up bounds for map
                this.cameras.main.startFollow(this.player); //Just in case we change the zoom level.
                this.cameras.main.roundPixels = true;

                //Animations for player
                this.anims.create({ //Animation left
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('player', { frames: [105, 104, 105, 106]}),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({ //Animation right
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('player', { frames: [104, 105, 106, 105] }),
                    frameRate: 10,
                    repeat: -1
                }); 
                this.anims.create({ //Animation up
                    key: 'up',
                    frames: this.anims.generateFrameNumbers('player', { frames: [101, 100, 102, 100]}),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({ //Animation down
                    key: 'down',
                    frames: this.anims.generateFrameNumbers('player', { frames: [ 97, 96, 97, 98 ] }),
                    frameRate: 10,
                    repeat: -1
                });
                this.physics.add.collider(this.player, obstacles); //Collision between player and obstacles

                this.spawns = this.physics.add.group({ classType: Phaser.GameObjects.Zone }); //invisible enemy generation
                for(var i = 1; i <= 6; i++) {
                    var x = i * 90;
                    for(var j = 1; j <=6; j++){
                        var y = 90 * j;
                        if (x == 540 && y == 540) {
                            //This is to prevent spawning an enemy on top of the player.
                        }
                        else {
                            this.spawns.create(x, y, 20, 20);
                        }
                    }         
                }        
                this.physics.add.overlap(this.player, this.spawns, this.onMeetEnemy, false, this); //If player touches enemy
                this.boss = this.physics.add.group({ classType: Phaser.GameObjects.Zone });
                this.boss.create(0, 165, 32, 64);
                this.physics.add.overlap(this.player, this.boss, this.onBoss, false, this); //If player reaches the boss.
                this.isBoss = false;
                this.sys.events.on('wake', this.wake, this);
            },
            update: function move (time, delta) //Allow movement
            {
                this.player.body.setVelocity(0);
            
                // Horizontal movement
                if (this.cursors.left.isDown)
                {
                    this.player.body.setVelocityX(-80);
                    this.player.flipX = true;
                    this.player.anims.play('left', true);
                }
                else if (this.cursors.right.isDown)
                {
                    this.player.body.setVelocityX(80);
                    this.player.flipX = false;
                    this.player.anims.play('right', true);
                }
                else if (!this.cursors.down.isDown && !this.cursors.up.isDown && !this.cursors.right.isDown && !this.cursors.left.isDown) //No movement, no animation
                {
                    this.player.anims.stop();
                } 

                if (this.cursors.up.isDown) // Vertical movement
                {
                    this.player.body.setVelocityY(-80); //Not changing flipX cause it doesn't really matter with vertical movement.
                    this.player.anims.play('up', true);
                }
                else if (this.cursors.down.isDown)
                {
                    this.player.body.setVelocityY(80);
                    this.player.anims.play('down', true);
                }   
                else if (!this.cursors.down.isDown && !this.cursors.up.isDown && !this.cursors.right.isDown && !this.cursors.left.isDown) //No movement, no animation
                {
                    this.player.anims.stop();
                } 
            },
            
            onMeetEnemy: function(player, zone) {
                //Destroy enemy
                zone.destroy();
                // shake the world and fade out
                this.cameras.main.shake(500);
                this.cameras.main.fadeOut(500);
                var timeEvent = this.time.addEvent({delay: 500, callback: this.battleStart, callbackScope: this}); //Start battle
            },

            onBoss: function(player, zone) {
                //Destroy enemy
                zone.destroy();
                // shake the world and fade out
                this.cameras.main.shake(500);
                this.cameras.main.fadeOut(500);
                var timeEvent = this.time.addEvent({delay: 500, callback: this.battleStart, callbackScope: this}); //Start battle
                this.isBoss = true;
            },

            wake: function() {
                this.cursors.left.reset();
                this.cursors.right.reset();
                this.cursors.up.reset();
                this.cursors.down.reset();
                this.cameras.main.fadeIn(300);
                this.soundFX.play();
            },

            battleStart: function() {
                this.soundFX.stop();
                this.scene.switch('BattleScene');
            },

            checkBoss: function () { //This will be used by the battle scene to determine if it is the boss battle or not
                return this.isBoss;
            }
        });

        var BattleScene = new Phaser.Class({
 
            Extends: Phaser.Scene,

            initialize:

            function BattleScene ()
            {
                Phaser.Scene.call(this, { key: 'BattleScene' });
            },
            create: function ()
            {
                this.cameras.main.setBackgroundColor('rgba(0, 200, 0, 0.5)'); //Background that looks kinda like grass
                bossBack = this.add.image(0, -350, 'start').setOrigin(0,0);
                bossBack.visible = false;
                this.cameras.main.fadeIn(300);
                this.soundFX = this.sound.add("Battle", {loop: "true"}); //Music
                this.soundFX.setVolume(0.5);
                this.soundFX.play();
                this.bossFX = this.sound.add("Boss", {loop: "true"}); //Boss Music
                this.bossFX.setVolume(0.5);
                player = new PlayerCharacter(this, 100, 250, 'player', 105, 'Apprentice', 100, 5); //Get us a player character!
                this.add.existing(player);
                hpText = this.add.text(50, 300, 'HP: 100', { fontSize: '30px', fill: '#000' }); //Show some text for current HP
                this.worldScene = this.scene.get('WorldScene'); //Needed to check for boss fight.
                if (this.worldScene.checkBoss()) {
                    this.soundFX.stop();
                    this.bossFX.play();
                    this.startBoss();
                }
                else {
                    this.startBattle();
                }
                // on wake event we call startBattle too
                this.sys.events.on('wake', this.wake, this);
            },

            exitBattle: function() {
                this.soundFX.stop();
                this.scene.sleep('UIScene');
                this.scene.switch('WorldScene');
            },

            wake: function() {
                this.cameras.main.fadeIn(300);
                this.soundFX.play();
                if (this.worldScene.checkBoss()) {
                    this.soundFX.stop();
                    this.bossFX.play();
                    this.startBoss();
                }
                else {
                    this.startBattle();
                }          
            },

            startBattle: function() {
                var rng = Phaser.Math.Between(1, 8); //Get number for random enemy grouping
                if (rng == 1) { //One Small
                    rng = Phaser.Math.Between(1,5); //Get a number for random enemy
                    if (rng == 1) {
                        var eRat = new Enemy(this, 500, 200, 'rat', 0, 'Dire Rat', 5, 15, 1);
                        this.add.existing(eRat);
                        this.enemies = [eRat];
                    }
                    else if (rng == 2) {
                        var eScor = new Enemy(this, 500, 200, 'scorpion', 0, 'Scorpion', 15, 15, 1);
                        this.add.existing(eScor);
                        this.enemies = [eScor];
                    }
                    else if (rng == 3) {
                        var eSlime = new Enemy(this, 500, 200, 'slime', 0, 'Slime', 20, 5, 1);
                        this.add.existing(eSlime);
                        this.enemies = [eSlime];
                    }
                    else if (rng == 4) {
                        var eDune = new Enemy(this, 500, 200, 'dune', 0, 'Dune Bug', 15, 10, 1);
                        this.add.existing(eDune);
                        this.enemies = [eDune];
                    }
                    else if (rng == 5) {
                        var eSpider = new Enemy(this, 500, 200, 'spider', 0, 'Dire Spider', 10, 10, 1);
                        this.add.existing(eSpider);
                        this.enemies = [eSpider];
                    }
                }
                else if (rng == 2) { //Two Small
                    var rng1 = Phaser.Math.Between(1,5);
                    var rng2 = Phaser.Math.Between(1,5); //We need 2 numbers now and need them at the same time
                    var nameA = ""; //This is a special tool that will help us later!
                    var nameB = "";
                    if (rng1 == rng2) { //Later is now. If the numbers are the same we need to know which enemy is which.
                        nameA = " A"; //This solves that problem by giving them a letter to designate each one.
                        nameB = " B";
                    }
                    if (rng1 == 1) {
                        var eRat = new Enemy(this, 400, 100, 'rat', 0, 'Dire Rat' + nameA, 5, 15, 1);
                        this.add.existing(eRat);
                        this.enemies = [eRat];
                    }
                    else if (rng1 == 2) {
                        var eScor = new Enemy(this, 400, 100, 'scorpion', 0, 'Scorpion' + nameA, 15, 15, 1);
                        this.add.existing(eScor);
                        this.enemies = [eScor];
                    }
                    else if (rng1 == 3) {
                        var eSlime = new Enemy(this, 400, 100, 'slime', 0, 'Slime' + nameA, 20, 5, 1);
                        this.add.existing(eSlime);
                        this.enemies = [eSlime];
                    }
                    else if (rng1 == 4) {
                        var eDune = new Enemy(this, 400, 100, 'dune', 0, 'Dune Bug' + nameA, 15, 10, 1);
                        this.add.existing(eDune);
                        this.enemies = [eDune];
                    }
                    else if (rng1 == 5) {
                        var eSpider = new Enemy(this, 400, 100, 'spider', 0, 'Dire Spider' + nameA, 10, 10, 1);
                        this.add.existing(eSpider);
                        this.enemies = [eSpider];
                    }
                    if (rng2 == 1) {
                        var eRat2 = new Enemy(this, 400, 300, 'rat', 0, 'Dire Rat' + nameB, 5, 15, 1);
                        this.add.existing(eRat2);
                        this.enemies.push(eRat2);
                    }
                    else if (rng2 == 2) {
                        var eScor2 = new Enemy(this, 400, 300, 'scorpion', 0, 'Scorpion' + nameB, 15, 15, 1);
                        this.add.existing(eScor2);
                        this.enemies.push(eScor2);
                    }
                    else if (rng2 == 3) {
                        var eSlime2 = new Enemy(this, 400, 300, 'slime', 0, 'Slime' + nameB, 20, 5, 1);
                        this.add.existing(eSlime2);
                        this.enemies.push(eSlime2);
                    }
                    else if (rng2 == 4) {
                        var eDune2 = new Enemy(this, 400, 300, 'dune', 0, 'Dune Bug' + nameB, 15, 10, 1);
                        this.add.existing(eDune2);
                        this.enemies.push(eDune2);
                    }
                    else if (rng2 == 5) {
                        var eSpider2 = new Enemy(this, 400, 300, 'spider', 0, 'Dire Spider' + nameB, 10, 10, 1);
                        this.add.existing(eSpider2);
                        this.enemies.push(eSpider2);
                    }
                }
                else if (rng == 3) { //Three Small
                    var rng1 = Phaser.Math.Between(1,5);
                    var rng2 = Phaser.Math.Between(1,5); //We need 3 numbers now and need them at the same time
                    var rng3 = Phaser.Math.Between(1,5);
                    var nameA = ""; //This is a special tool that will help us later!
                    var nameB = "";
                    var nameC = "";
                    if (rng1 == rng2 && rng1 != rng3) { //Later is now. If the numbers are the same we need to know which enemy is which.
                        nameA = " A"; //This solves that problem by giving them a letter to designate each one.
                        nameB = " B";
                    }
                    else if (rng2 == rng3 && rng2 != rng1) {
                        nameB = " A";
                        nameC = " B";
                    }
                    else if (rng1 == rng3 && rng1 != rng2) {
                        nameA = " A";
                        nameC = " B";
                    }
                    else if (rng1 == rng2 && rng1 == rng3) {
                        nameA = " A";
                        nameB = " B";
                        nameC = " C";
                    }
                    if (rng1 == 1) {
                        var eRat = new Enemy(this, 400, 100, 'rat', 0, 'Dire Rat' + nameA, 5, 15, 1);
                        this.add.existing(eRat);
                        this.enemies = [eRat];
                    }
                    else if (rng1 == 2) {
                        var eScor = new Enemy(this, 400, 100, 'scorpion', 0, 'Scorpion' + nameA, 15, 15, 1);
                        this.add.existing(eScor);
                        this.enemies = [eScor];
                    }
                    else if (rng1 == 3) {
                        var eSlime = new Enemy(this, 400, 100, 'slime', 0, 'Slime' + nameA, 20, 5, 1);
                        this.add.existing(eSlime);
                        this.enemies = [eSlime];
                    }
                    else if (rng1 == 4) {
                        var eDune = new Enemy(this, 400, 100, 'dune', 0, 'Dune Bug' + nameA, 15, 10, 1);
                        this.add.existing(eDune);
                        this.enemies = [eDune];
                    }
                    else if (rng1 == 5) {
                        var eSpider = new Enemy(this, 400, 100, 'spider', 0, 'Dire Spider' + nameA, 10, 10, 1);
                        this.add.existing(eSpider);
                        this.enemies = [eSpider];
                    }
                    if (rng2 == 1) {
                        var eRat2 = new Enemy(this, 400, 300, 'rat', 0, 'Dire Rat' + nameB, 5, 15, 1);
                        this.add.existing(eRat2);
                        this.enemies.push(eRat2);
                    }
                    else if (rng2 == 2) {
                        var eScor2 = new Enemy(this, 400, 300, 'scorpion', 0, 'Scorpion' + nameB, 15, 15, 1);
                        this.add.existing(eScor2);
                        this.enemies.push(eScor2);
                    }
                    else if (rng2 == 3) {
                        var eSlime2 = new Enemy(this, 400, 300, 'slime', 0, 'Slime' + nameB, 20, 5, 1);
                        this.add.existing(eSlime2);
                        this.enemies.push(eSlime2);
                    }
                    else if (rng2 == 4) {
                        var eDune2 = new Enemy(this, 400, 300, 'dune', 0, 'Dune Bug' + nameB, 15, 10, 1);
                        this.add.existing(eDune2);
                        this.enemies.push(eDune2);
                    }
                    else if (rng2 == 5) {
                        var eSpider2 = new Enemy(this, 400, 300, 'spider', 0, 'Dire Spider' + nameB, 10, 10, 1);
                        this.add.existing(eSpider2);
                        this.enemies.push(eSpider2);
                    }
                    if (rng3 == 1) {
                        var eRat3 = new Enemy(this, 500, 200, 'rat', 0, 'Dire Rat' + nameC, 5, 15, 1);
                        this.add.existing(eRat3);
                        this.enemies.push(eRat3);
                    }
                    else if (rng3 == 2) {
                        var eScor3 = new Enemy(this, 500, 200, 'scorpion', 0, 'Scorpion' + nameC, 15, 15, 1);
                        this.add.existing(eScor3);
                        this.enemies.push(eScor3);
                    }
                    else if (rng3 == 3) {
                        var eSlime3 = new Enemy(this, 500, 200, 'slime', 0, 'Slime' + nameC, 20, 5, 1);
                        this.add.existing(eSlime3);
                        this.enemies.push(eSlime3);
                    }
                    else if (rng3 == 4) {
                        var eDune3 = new Enemy(this, 500, 200, 'dune', 0, 'Dune Bug' + nameC, 15, 10, 1);
                        this.add.existing(eDune3);
                        this.enemies.push(eDune3);
                    }
                    else if (rng3 == 5) {
                        var eSpider3 = new Enemy(this, 500, 200, 'spider', 0, 'Dire Spider' + nameC, 10, 10, 1);
                        this.add.existing(eSpider3);
                        this.enemies.push(eSpider3);
                    }
                }
                else if (rng == 4) { //One Medium
                    rng = Phaser.Math.Between(1,5);
                    if (rng == 1) {
                        var eBat = new Enemy(this, 500, 200, 'bat', 0, 'Dire Bat', 15, 15, 2);
                        this.add.existing(eBat);
                        this.enemies = [eBat];
                    }
                    else if (rng == 2) {
                        var eSkel = new Enemy(this, 500, 200, 'skeleton', 0, 'Skeleton', 20, 20, 2);
                        this.add.existing(eSkel);
                        this.enemies = [eSkel];
                    }
                    else if (rng == 3) {
                        var eSnake = new Enemy(this, 500, 200, 'snake', 0, 'Dire Snake', 15, 20, 2);
                        this.add.existing(eSnake);
                        this.enemies = [eSnake];
                    }
                    else if (rng == 4) {
                        var eDemon = new Enemy(this, 500, 200, 'demon', 0, 'Demon', 30, 20, 2);
                        this.add.existing(eDemon);
                        this.enemies = [eDemon];
                    }
                    else if (rng == 5) {
                        var eTree = new Enemy(this, 500, 200, 'tree', 0, 'Cursed Tree', 40, 10, 2);
                        this.add.existing(eTree);
                        this.enemies = [eTree];
                    }
                }
                else if (rng == 5){ //Two Medium
                    var rng1 = Phaser.Math.Between(1,5);
                    var rng2 = Phaser.Math.Between(1,5); //We need 2 numbers now and need them at the same time
                    var nameA = ""; //This is a special tool that will help us later!
                    var nameB = "";
                    if (rng1 == rng2) { //Later is now. If the numbers are the same we need to know which enemy is which.
                        nameA = " A"; //This solves that problem by giving them a letter to designate each one.
                        nameB = " B";
                    }
                    if (rng1 == 1) {
                        var eBat = new Enemy(this, 400, 100, 'bat', 0, 'Dire Bat' + nameA, 15, 15, 2);
                        this.add.existing(eBat);
                        this.enemies = [eBat];
                    }
                    else if (rng1 == 2) {
                        var eSkel = new Enemy(this, 400, 100, 'skeleton', 0, 'Skeleton' + nameA, 20, 20, 2);
                        this.add.existing(eSkel);
                        this.enemies = [eSkel];
                    }
                    else if (rng1 == 3) {
                        var eSnake = new Enemy(this, 400, 100, 'snake', 0, 'Dire Snake' + nameA, 15, 20, 2);
                        this.add.existing(eSnake);
                        this.enemies = [eSnake];
                    }
                    else if (rng1 == 4) {
                        var eDemon = new Enemy(this, 400, 100, 'demon', 0, 'Demon' + nameA, 30, 20, 2);
                        this.add.existing(eDemon);
                        this.enemies = [eDemon];
                    }
                    else if (rng1 == 5) {
                        var eTree = new Enemy(this, 400, 100, 'tree', 0, 'Cursed Tree' + nameA, 40, 10, 2);
                        this.add.existing(eTree);
                        this.enemies = [eTree];
                    }
                    if (rng2 == 1) {
                        var eBat2 = new Enemy(this, 400, 300, 'bat', 0, 'Dire Bat' + nameB, 15, 15, 2);
                        this.add.existing(eBat2);
                        this.enemies.push(eBat2);
                    }
                    else if (rng2 == 2) {
                        var eSkel2 = new Enemy(this, 400, 300, 'skeleton', 0, 'Skeleton' + nameB, 20, 20, 2);
                        this.add.existing(eSkel2);
                        this.enemies.push(eSkel2);
                    }
                    else if (rng2 == 3) {
                        var eSnake2 = new Enemy(this, 400, 300, 'snake', 0, 'Dire Snake' + nameB, 15, 20, 2);
                        this.add.existing(eSnake2);
                        this.enemies.push(eSnake2);
                    }
                    else if (rng2 == 4) {
                        var eDemon2 = new Enemy(this, 400, 300, 'demon', 0, 'Demon' + nameB, 30, 20, 2);
                        this.add.existing(eDemon2);
                        this.enemies.push(eDemon2);
                    }
                    else if (rng2 == 5) {
                        var eTree2 = new Enemy(this, 400, 300, 'tree', 0, 'Cursed Tree' + nameB, 40, 10, 2);
                        this.add.existing(eTree2);
                        this.enemies.push(eTree2);
                    }
                }
                else if (rng == 6) { //One Medium, One Small
                    rng = Phaser.Math.Between(1,5); //Get a number for random enemy 1
                    if (rng == 1) {
                        var eRat = new Enemy(this, 400, 100, 'rat', 0, 'Dire Rat', 5, 5, 1);
                        this.add.existing(eRat);
                        this.enemies = [eRat];
                    }
                    else if (rng == 2) {
                        var eScor = new Enemy(this, 400, 100, 'scorpion', 0, 'Scorpion', 5, 5, 1);
                        this.add.existing(eScor);
                        this.enemies = [eScor];
                    }
                    else if (rng == 3) {
                        var eSlime = new Enemy(this, 400, 100, 'slime', 0, 'Slime', 5, 5, 1);
                        this.add.existing(eSlime);
                        this.enemies = [eSlime];
                    }
                    else if (rng == 4) {
                        var eDune = new Enemy(this, 400, 100, 'dune', 0, 'Dune Bug', 5, 5, 1);
                        this.add.existing(eDune);
                        this.enemies = [eDune];
                    }
                    else if (rng == 5) {
                        var eSpider = new Enemy(this, 400, 100, 'spider', 0, 'Dire Spider', 5, 5, 1);
                        this.add.existing(eSpider);
                        this.enemies = [eSpider];
                    }
                    rng = Phaser.Math.Between(1,5); //Get a random number for enemy 2
                    if (rng == 1) {
                        var eBat = new Enemy(this, 400, 300, 'bat', 0, 'Dire Bat', 15, 15, 2);
                        this.add.existing(eBat);
                        this.enemies.push(eBat);
                    }
                    else if (rng == 2) {
                        var eSkel = new Enemy(this, 400, 300, 'skeleton', 0, 'Skeleton', 20, 20, 2);
                        this.add.existing(eSkel);
                        this.enemies.push(eSkel);
                    }
                    else if (rng == 3) {
                        var eSnake = new Enemy(this, 400, 300, 'snake', 0, 'Dire Snake', 15, 20, 2);
                        this.add.existing(eSnake);
                        this.enemies.push(eSnake);
                    }
                    else if (rng == 4) {
                        var eDemon = new Enemy(this, 400, 300, 'demon', 0, 'Demon', 30, 20, 2);
                        this.add.existing(eDemon);
                        this.enemies.push(eDemon);
                    }
                    else if (rng == 5) {
                        var eTree = new Enemy(this, 400, 300, 'tree', 0, 'Cursed Tree', 40, 10, 2);
                        this.add.existing(eTree);
                        this.enemies.push(eTree);
                    }
                }
                else if (rng == 7) { //One Medium, Two Small
                    var rng1 = Phaser.Math.Between(1,5);
                    var rng2 = Phaser.Math.Between(1,5); //We need 3 numbers now and need them at the same time
                    var rng3 = Phaser.Math.Between(1,5);
                    var nameA = ""; //This is a special tool that will help us later!
                    var nameB = "";
                    if (rng1 == rng2) { //Later is now. If the numbers are the same we need to know which enemy is which.
                        nameA = " A"; //This solves that problem by giving them a letter to designate each one.
                        nameB = " B";
                    }
                    if (rng1 == 1) {
                        var eRat = new Enemy(this, 400, 100, 'rat', 0, 'Dire Rat' + nameA, 5, 15, 1);
                        this.add.existing(eRat);
                        this.enemies = [eRat];
                    }
                    else if (rng1 == 2) {
                        var eScor = new Enemy(this, 400, 100, 'scorpion', 0, 'Scorpion' + nameA, 15, 15, 1);
                        this.add.existing(eScor);
                        this.enemies = [eScor];
                    }
                    else if (rng1 == 3) {
                        var eSlime = new Enemy(this, 400, 100, 'slime', 0, 'Slime' + nameA, 20, 5, 1);
                        this.add.existing(eSlime);
                        this.enemies = [eSlime];
                    }
                    else if (rng1 == 4) {
                        var eDune = new Enemy(this, 400, 100, 'dune', 0, 'Dune Bug' + nameA, 15, 10, 1);
                        this.add.existing(eDune);
                        this.enemies = [eDune];
                    }
                    else if (rng1 == 5) {
                        var eSpider = new Enemy(this, 400, 100, 'spider', 0, 'Dire Spider' + nameA, 10, 10, 1);
                        this.add.existing(eSpider);
                        this.enemies = [eSpider];
                    }
                    if (rng2 == 1) {
                        var eRat2 = new Enemy(this, 400, 300, 'rat', 0, 'Dire Rat' + nameB, 5, 15, 1);
                        this.add.existing(eRat2);
                        this.enemies.push(eRat2);
                    }
                    else if (rng2 == 2) {
                        var eScor2 = new Enemy(this, 400, 300, 'scorpion', 0, 'Scorpion' + nameB, 15, 15, 1);
                        this.add.existing(eScor2);
                        this.enemies.push(eScor2);
                    }
                    else if (rng2 == 3) {
                        var eSlime2 = new Enemy(this, 400, 300, 'slime', 0, 'Slime' + nameB, 20, 5, 1);
                        this.add.existing(eSlime2);
                        this.enemies.push(eSlime2);
                    }
                    else if (rng2 == 4) {
                        var eDune2 = new Enemy(this, 400, 300, 'dune', 0, 'Dune Bug' + nameB, 15, 10, 1);
                        this.add.existing(eDune2);
                        this.enemies.push(eDune2);
                    }
                    else if (rng2 == 5) {
                        var eSpider2 = new Enemy(this, 400, 300, 'spider', 0, 'Dire Spider' + nameB, 10, 10, 1);
                        this.add.existing(eSpider2);
                        this.enemies.push(eSpider2);
                    }
                    if (rng3 == 1) {
                        var eBat = new Enemy(this, 500, 200, 'bat', 0, 'Dire Bat', 15, 15, 2);
                        this.add.existing(eBat);
                        this.enemies.push(eBat);
                    }
                    else if (rng3 == 2) {
                        var eSkel = new Enemy(this, 500, 200, 'skeleton', 0, 'Skeleton', 20, 20, 2);
                        this.add.existing(eSkel);
                        this.enemies.push(eSkel);
                    }
                    else if (rng3 == 3) {
                        var eSnake = new Enemy(this, 500, 200, 'snake', 0, 'Dire Snake', 15, 20, 2);
                        this.add.existing(eSnake);
                        this.enemies.push(eSnake);
                    }
                    else if (rng3 == 4) {
                        var eDemon = new Enemy(this, 500, 200, 'demon', 0, 'Demon', 30, 20, 2);
                        this.add.existing(eDemon);
                        this.enemies.push(eDemon);
                    }
                    else if (rng3 == 5) {
                        var eTree = new Enemy(this, 500, 200, 'tree', 0, 'Cursed Tree', 40, 10, 2);
                        this.add.existing(eTree);
                        this.enemies.push(eTree);
                    }
                }
                else if (rng == 8){ //One Large Enemy
                    rng = Phaser.Math.Between(1,5);
                    if (rng == 1) {
                        var eHorror = new Enemy(this, 500, 200, 'horror', 0, 'Elder Horror', 100, 45, 5);
                        this.add.existing(eHorror);
                        this.enemies = [eHorror];
                    }
                    else if (rng == 2) {
                        var eDrake = new Enemy(this, 500, 200, 'drake', 0, 'Drake', 125, 40, 5);
                        this.add.existing(eDrake);
                        this.enemies = [eDrake];
                    }
                    else if (rng == 3) {
                        var eDec = new Enemy(this, 500, 200, 'deceleon', 0, 'Deceleon', 200, 25, 5);
                        this.add.existing(eDec);
                        this.enemies = [eDec];
                    }
                    else if (rng == 4) {
                        var eLizard = new Enemy(this, 500, 200, 'lizard', 0, 'Lizard Beast', 175, 30, 5);
                        this.add.existing(eLizard);
                        this.enemies = [eLizard];
                    }
                    else if (rng == 5) {
                        var eNaga = new Enemy(this, 500, 200, 'nagaruda', 0, 'Nagaruda', 150, 35, 5);
                        this.add.existing(eNaga);
                        this.enemies = [eNaga];
                    }
                }
                exp = 0; //We will determine how much Experience to give based on the size of the enemies put together.
                for (var i = 0; i < this.enemies.length; i++) {
                    exp += this.enemies[i].size;
                }

                this.hero = [player];
                this.units = this.hero.concat(this.enemies); //Puts everything into one list
                
                this.index = -1; // currently active unit
                
                this.scene.run("UIScene");        
            },

            startBoss: function() {
                bossBack.visible = true;
                var eAurum = new Boss(this, 450, 150, 'aurum', 0, 'Aurum', 5, 5, 5);
                this.add.existing(eAurum);
                this.enemies = [eAurum];
                exp = 5;

                this.hero = [player];
                this.units = this.hero.concat(this.enemies); //Puts everything into one list
                
                this.index = -1; // currently active unit
                
                this.scene.run("UIScene"); 
            },

            nextTurn: function() {  
                // if we have victory or game over
                var battleState = this.checkEndBattle();
                if(battleState === "Victory") {  //You Win!
                    var level = player.expGain(exp); //Gain Exp
                    if (level === "LevelUp") {
                        hpText.setText("HP: " + player.hp); //Leveling Up refills HP so this will reflect that if it comes up.
                        var timeEvent = this.time.addEvent({delay: 2500, callback: this.levelFade, callbackScope: this});
                    }
                    else {
                        this.cameras.main.fadeOut(500);         
                        var timeEvent = this.time.addEvent({delay: 500, callback: this.exitBattle, callbackScope: this});
                    }
                    return;
                }
                if(battleState === "BossVictory") { //You beat the game!
                    this.scene.stop('UIScene');
                    hpText.setText("");
                    this.cameras.main.fadeOut(1000);
                    this.cameras.main.shake(1000);
                    var timeEvent = this.time.addEvent({delay: 1000, callback: this.winGame, callbackScope: this});
                    
                    return;
                }
                if(battleState === "GameOver") { //YOU LOSE!
                    this.cameras.main.fadeOut(300);
                    this.scene.remove('UIScene');
                    var timeEvent = this.time.addEvent({delay: 400, callback: this.gameOverMan, callbackScope: this});
                }
                do {
                    // currently active unit
                    this.index++;
                    // if there are no more units, we start again from the first one
                    if(this.index >= this.units.length) {
                        this.index = 0;
                    }            
                } while(!this.units[this.index].living);
                // if its player hero
                if(this.units[this.index] instanceof PlayerCharacter) {
                    // we need the player to select action
                    this.events.emit("ActionSelect", this.index);
                } 
                else if (this.units[this.index] instanceof Boss) {
                    //For right now, just act like an enemy
                    this.units[this.index].attack(this.hero[0]); 
                    hpText.setText("HP: " + player.hp); //Show the new HP total
                    this.cameras.main.shake(100); //Visual effect for the player to understand they got hurt.
                    this.sound.play("Attack");
                    // add timer for the next turn, so will have smooth gameplay
                    this.time.addEvent({ delay: 3000, callback: this.nextTurn, callbackScope: this });
                }
                else { // else if its enemy unit
                    // call the enemy's attack function 
                    this.units[this.index].attack(this.hero[0]); 
                    hpText.setText("HP: " + player.hp); //Show the new HP total
                    this.cameras.main.shake(100); //Visual effect for the player to understand they got hurt.
                    this.sound.play("Attack");
                    // add timer for the next turn, so will have smooth gameplay
                    this.time.addEvent({ delay: 3000, callback: this.nextTurn, callbackScope: this });
                }
            },

            levelFade: function() { //Just to make the level up feel a bit better.
                this.cameras.main.fadeOut(500);         
                var timeEvent = this.time.addEvent({delay: 500, callback: this.exitBattle, callbackScope: this});
            },

            checkEndBattle: function() {       
                var bossFight = this.worldScene.checkBoss(); 
                var victory = true;
                // if all enemies are dead we have victory
                for(var i = 0; i < this.enemies.length; i++) {
                    if(this.enemies[i].living)
                        victory = false;
                }
                var gameOver = true;
                // if hero is dead we have game over
                if(this.hero[0].living)
                    gameOver = false;
                
                if(victory && bossFight) {return "BossVictory";}
                else if (victory) {return "Victory";}
                else if(gameOver) {return "GameOver";}
            },

            endBattle: function() {       
                // clear state, remove sprites
                this.enemies.length = 0;
                for(var i = 0; i < this.enemies.length; i++) {
                    // link item
                    this.enemies[i].destroy();            
                }
                this.units.length = 0;
                // sleep the UI
                this.scene.sleep('UIScene');
                // return to WorldScene and sleep current BattleScene
                this.scene.switch('WorldScene');
            },

            receivePlayerSelection: function(action, target) { //This lets us understand what the player is trying to do in the menus.
                if(action == 'attack') {            
                    this.units[this.index].attack(this.enemies[target]);              
                    this.sound.play("Attack"); //Play associated sound effect
                }
                else if(action == 'heal') {
                    this.units[this.index].heal();
                    hpText.setText("HP: " + player.hp);
                    this.sound.play("Spell");
                }
                else if (action == 'magicmissle') {
                    this.units[this.index].magicmissle(this.enemies[target]);
                    this.sound.play("Spell");
                }
                else if(action == 'firebolt') {
                    this.units[this.index].firebolt(this.enemies[target]);
                    this.sound.play("Spell");
                }
                else if (action == 'icespike') {
                    this.units[this.index].icespike(this.enemies[target]);
                    this.sound.play("Spell");
                }
                else if (action == 'shockblast') {
                    this.units[this.index].shockblast(this.enemies[target]);
                    this.sound.play("Spell");
                }
                else if (action == 'doombolt') {
                    this.units[this.index].doombolt(this.enemies[target]);
                    this.sound.play("Spell");
                }
                else if (action == 'death') {
                    this.cameras.main.fadeIn(100);
                    this.units[this.index].death(this.enemies[target]);
                    this.sound.play("Spell");
                }
                this.time.addEvent({ delay: 3000, callback: this.nextTurn, callbackScope: this });        
            },

            gameOverMan: function() { //Launch the game over screen
                this.scene.start('EndScene');
                this.soundFX.stop();
                this.bossFX.stop();
            },

            winGame: function() { //Launch the win screen
                this.scene.start('WinScene');
                this.bossFX.stop();
            }
        });

        var UIScene = new Phaser.Class({

            Extends: Phaser.Scene,

            initialize:

            function UIScene ()
            {
                Phaser.Scene.call(this, { key: 'UIScene' });
            },

            create: function ()
            {    
                console.log("Use Arrow Keys to interact with menus."); //Just for a little bit of help outside of the Readme.
                this.graphics = this.add.graphics(); //Make the menu boxes
                this.graphics.lineStyle(1, 0xffffff);
                this.graphics.fillStyle(0x031f4c, 1);        
                this.graphics.strokeRect(2, 430, 210, 205);
                this.graphics.fillRect(2, 430, 210, 205);
                this.graphics.strokeRect(214, 430, 210, 205);
                this.graphics.fillRect(214, 430, 210, 205);
                this.graphics.strokeRect(426, 430, 210, 205);
                this.graphics.fillRect(426, 430, 210, 205);

                // basic container to hold all menus
                this.menus = this.add.container();
                
                this.actionsMenu = new ActionsMenu(18, 430, this);           //Get menues set up
                this.spellsMenu = new SpellsMenu(230, 430, this);            
                this.enemiesMenu = new EnemiesMenu(442, 430, this);   
                
                // the currently selected menu 
                this.currentMenu = this.actionsMenu;
                
                // add menus to the container
                this.menus.add(this.actionsMenu);
                this.menus.add(this.spellsMenu);
                this.menus.add(this.enemiesMenu);

                this.battleScene = this.scene.get('BattleScene'); //Needed to access battle stuff

                this.input.keyboard.on('keydown', this.onKeyInput, this); //Get input
                this.battleScene.events.on("ActionSelect", this.onActionSelect, this); //This one makes sure the battlescene can understand too.
                this.events.on("ActionSelect", this.onActionSelect, this); //Event callouts for each menu
                this.events.on("SelectSpells", this.onSelectSpells, this);
                this.events.on("SelectEnemies", this.onSelectEnemies, this);
                this.events.on("Enemy", this.onEnemy, this);
                // when the scene receives wake event
                this.sys.events.on('wake', this.createMenu, this);
                
                // the message describing the current action
                this.message = new Message(this, this.battleScene.events);
                this.add.existing(this.message);        
                
                this.createMenu();
            },

            createMenu: function() {
                // map enemies menu items to enemies
                var enemies = this.battleScene.enemies;
                this.enemiesMenu.remap(enemies);
                this.spellsMenu.remap(player.spells); //Also set up spells menu, spells will be expanded later
                // first move
                this.battleScene.nextTurn(); 
            },

            onKeyInput: function(event) {
                if(this.currentMenu && this.currentMenu.selected) { //Just to figure out what the player is trying to do
                    if(event.code === "ArrowUp") {
                        this.currentMenu.moveSelectionUp();
                        this.sound.play("Select");
                    } else if(event.code === "ArrowDown") {
                        this.currentMenu.moveSelectionDown();
                        this.sound.play("Select");
                    } else if(event.code === "ArrowLeft" || event.code === "Shift") {
                        this.currentMenu.back();
                        this.sound.play("Back");
                    } else if(event.code === "Space" || event.code === "ArrowRight") {
                        this.currentMenu.confirm();
                        this.sound.play("Confirm");
                    } 
                }
            },

            onActionSelect: function() {
                this.currentMenu = this.actionsMenu;
                this.actionsMenu.select(0);
            },

            onSelectSpells: function() {
                this.currentMenu = this.spellsMenu;
                this.spellsMenu.select(0);
            },

            onSelectEnemies: function(action) {
                this.currentMenu = this.enemiesMenu;
                this.enemiesMenu.select(0);
                this.enemiesMenu.setAction(action);
            },

            onEnemy: function(action, index) {
                this.actionsMenu.deselect();
                this.spellsMenu.deselect();
                this.enemiesMenu.deselect();
                this.currentMenu = null;
                this.battleScene.receivePlayerSelection(action, index);
            },
        });

        var EndScene = new Phaser.Class({
            Extends: Phaser.Scene,
            initialize:

            function EndScene() {
                Phaser.Scene.call(this, {key: 'EndScene'});
            },
            create: function() {
                this.cameras.main.fadeIn(300); //Visual stuff
                this.soundFX = this.sound.add("GameOver", {loop: "true"}); //Music
                this.soundFX.setVolume(0.5);
                this.soundFX.play();
                this.add.text(150, 200, "GAME OVER", {fontSize: '60px', fill: '#ff0000'}); //Gotta let the player know what's up.
            }
        });

        var WinScene = new Phaser.Class({
            Extends: Phaser.Scene,
            initialize:

            function WinScene() {
                Phaser.Scene.call(this, {key: 'WinScene'});
            },
            create: function() {
                this.cameras.main.fadeIn(1000);
                this.soundFX = this.sound.add("Start", {loop: "true"});
                this.soundFX.play();
                this.cameras.main.setBackgroundColor('rgba(0, 200, 0, 0.5)');
                this.add.image(0, 0, 'start').setOrigin(0,0);
                this.add.text(150, 200, "YOU WIN!!!", {fontSize: '60px', fill: "#0b1f01"});
            }
        });

        var config = { //OOOOH BOY complicated phaser stuff like setting screen size and zoom.
        type: Phaser.AUTO,
        parent: 'content',
        width: 640,
        height: 640,
        zoom: 1,
        pixelArt: true,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: true
            }
        },
        scene: [
            BootScene,
            WorldScene,
            BattleScene,
            UIScene,
            EndScene,
            WinScene
        ]
        };
        var game = new Phaser.Game(config);

        var Unit = new Phaser.Class({
            Extends: Phaser.GameObjects.Sprite,
        
            initialize: //This class will be a catch-all for some basic info for all enemies, the player, and the future boss.
        
            function Unit(scene, x, y, texture, frame, type, hp, damage) {
                Phaser.GameObjects.Sprite.call(this, scene, x, y, texture, frame); //Visual representation
                this.type = type; //Basically a name
                this.maxHp = this.hp = hp; //Set up their Max HP and current HP
                this.damage = damage; // default damage     
                this.living = true;         //ITS ALIVE! ALIVE!!!
                this.menuItem = null;         
            },
            setMenuItem: function(item) {
                this.menuItem = item; //Mainly for enemies, won't really be needed for the hero, but will be for the boss as well.
            },
            attack: function(target) {
                if(target.living) { //Basic attack, make sure we can't somehow hit a dead enemy.
                    target.takeDamage(this.damage);
                    this.scene.events.emit("Message", this.type + " attacks " + target.type + " for " + this.damage + " damage");
                }
            },    
            takeDamage: function(damage) {
                this.hp -= damage; //Talk S*** get Hit
                if(this.hp <= 0) { //IS HE DEAD?!
                    this.hp = 0; //He's dead Jim
                    if(this.menuItem != null) {
                        this.menuItem.unitKilled();
                    }
                    this.living = false; 
                    this.visible = false; //Get him out of here!   
                    this.menuItem = null;
                }
                else if(this.hp > this.maxHp) { //This handles Healing and makes sure they can't surpass the Max HP
                    this.hp = this.maxHp;
                }
            }   
        });

        var Enemy = new Phaser.Class({
            Extends: Unit,
        
            initialize:
            function Enemy(scene, x, y, texture, frame, type, hp, damage, size) {
                Unit.call(this, scene, x, y, texture, frame, type, hp, damage);
                this.size = size; //Basic enemies are more or less just units but with a Size which is partly for sorting, mainly for EXP
            }
        });

        var Boss = new Phaser.Class({
            Extends: Enemy,

            initialize:
            function Boss(scene, x, y, texture, frame, type, hp, damage, size) {
                Enemy.call(this, scene, x, y, texture, frame, type, hp, damage, size);
            }
        });

        var PlayerCharacter = new Phaser.Class({
            Extends: Unit,
        
            initialize:
            function PlayerCharacter(scene, x, y, texture, frame, type, hp, damage) {
                Phaser.GameObjects.Sprite.call(this, scene, x, y, texture, frame); //Player ended up WAY more complex
                this.type = type; //So a lot of this stuff needed to be in here too
                this.maxHp = this.hp = hp;
                this.damage = damage;     
                this.living = true;         
                this.menuItem = null;
                this.setScale(2); //I like em Big
                this.exp = 0; //Starting EXP
                this.level = 1; //Starting Level
                this.spells = ["Magic Missle"]; //Starting Spells, only 1 at the moment.
            },

            expGain: function(gain) { //This will be called to gain exp and handle level ups. 
                this.exp += gain; //Increase EXP
                if (this.exp >= 5) { //Check for level up
                    if (this.level != 20) {
                        this.exp -= 5;
                        this.level += 1;
                        this.maxHp += 10;
                        this.hp = this.maxHp;
                        if (this.level % 4 == 0) {
                            this.damage += 5;
                        }
                        this.scene.events.emit("Message", "Level Up! You are now Level " + this.level + "!");
                        if (this.level == 4) {
                            this.spells.push("Fire Bolt");
                            this.type = "Sorcerer";
                        }
                        else if (this.level == 8) {
                            this.spells.push("Ice Spike");
                            this.type = "Mage";
                        }
                        else if (this.level == 12) {
                            this.spells.push("Shock Blast");
                            this.type = "Wizard";
                        }
                        else if (this.level == 16) {
                            this.spells.push("Doom Bolt");
                            this.type = "Archmage";
                        }
                        else if (this.level == 20) {
                            this.spells.push("Death");
                            this.type = "Grand Arcanist";
                            this.maxHp = 300;
                            this.hp = this.maxHp;
                        }
                        return "LevelUp";
                    }
                }
            },

            heal: function() { //Let's the player heal up.
                this.takeDamage(-50);
                this.scene.events.emit("Message", this.type + " heals 50 health");
            },

            magicmissle: function(target) {
                if(target.living) {
                    target.takeDamage(10);
                    this.scene.events.emit("Message", this.type + " cast Magic Missle on " + target.type + " for 10 damage.");
                }
            },

            firebolt: function(target) { //Basic spell, similar to attack with fixed damage.
                if(target.living) {
                    target.takeDamage(20);
                    this.scene.events.emit("Message", this.type + " cast Fire Bolt on " + target.type + " for 20 damage.");
                }
            },

            icespike: function(target) {
                if(target.living) {
                    target.takeDamage(30);
                    this.scene.events.emit("Message", this.type + " cast Ice Spike on " + target.type + " for 30 damage.");
                }
            },

            shockblast: function(target) {
                if(target.living) {
                    target.takeDamage(40);
                    this.scene.events.emit("Message", this.type + " cast Shock Blast on " + target.type + " for 40 damage.");
                }
            },

            doombolt: function(target) {
                if(target.living) {
                    target.takeDamage(50);
                    this.scene.events.emit("Message", this.type + " cast Doom Bolt on " + target.type + " for 50 damage.");
                }
            },

            death: function(target) {
                if (target.living) {
                    target.takeDamage(100);
                    this.scene.events.emit("Message", this.type + " cast Death on " + target.type + " for 100 damage.");
                }
            }
        });

        var MenuItem = new Phaser.Class({
            Extends: Phaser.GameObjects.Text,
            
            initialize: //This handles how menu items actually work on the menu.
                    
            function MenuItem(x, y, text, scene) {
                Phaser.GameObjects.Text.call(this, scene, x, y, text, { color: '#ffffff', align: 'left', fontSize: 25}); //Make it visible
            },
            
            select: function() {
                this.setColor('#f8ff38'); //Change color to reflect what is being selected
            },
            
            deselect: function() {
                this.setColor('#ffffff'); //Change it back
            },

            // when the associated enemy or player unit is killed
            unitKilled: function() {
                this.active = false;
                this.visible = false;
            }
            
        });

        var Menu = new Phaser.Class({
            Extends: Phaser.GameObjects.Container,
            
            initialize: //Handles the actual menus
                    
            function Menu(x, y, scene, heroes) {
                Phaser.GameObjects.Container.call(this, scene, x, y); //A menu is just a container for menu items basically.
                this.menuItems = [];
                this.menuItemIndex = 0;
                this.x = x;
                this.y = y;        
                this.selected = false;
            },     
            addMenuItem: function(unit) { //This matters for enemies and, later, spells.
                var menuItem = new MenuItem(-5, this.menuItems.length * 20, unit, this.scene);
                this.menuItems.push(menuItem);
                this.add(menuItem); 
                return menuItem;
            },  
            // menu navigation 
            moveSelectionUp: function() { //Let's the player change selection, and let's the menu understand what that means.
                this.menuItems[this.menuItemIndex].deselect();
                do {
                    this.menuItemIndex--;
                    if(this.menuItemIndex < 0)
                        this.menuItemIndex = this.menuItems.length - 1;
                } while(!this.menuItems[this.menuItemIndex].active);
                this.menuItems[this.menuItemIndex].select();
            },
            moveSelectionDown: function() {
                this.menuItems[this.menuItemIndex].deselect();
                do {
                    this.menuItemIndex++;
                    if(this.menuItemIndex >= this.menuItems.length)
                        this.menuItemIndex = 0;
                } while(!this.menuItems[this.menuItemIndex].active);
                this.menuItems[this.menuItemIndex].select();
            },
            // select the menu as a whole and highlight the choosen element
            select: function(index) {
                if(!index)
                    index = 0;       
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex = index;
                while(!this.menuItems[this.menuItemIndex].active) {
                    this.menuItemIndex++;
                    if(this.menuItemIndex >= this.menuItems.length)
                        this.menuItemIndex = 0;
                    if(this.menuItemIndex == index)
                        return;
                }        
                this.menuItems[this.menuItemIndex].select();
                this.selected = true;
            },
            // deselect this menu
            deselect: function() {        
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex = 0;
                this.selected = false;
            },
            confirm: function() {
                // when the player confirms his slection, do the action. This and Back exist for later classes.
            },
            back: function() {
                //Go back to previous menu, if possible.
            },
            // clear menu and remove all menu items
            clear: function() {
                for(var i = 0; i < this.menuItems.length; i++) {
                    this.menuItems[i].destroy();
                }
                this.menuItems.length = 0;
                this.menuItemIndex = 0;
            }
        });

        var ActionsMenu = new Phaser.Class({
            Extends: Menu,
            
            initialize: //This menu handles all the player actions.
                    
            function ActionsMenu(x, y, scene) {
                Menu.call(this, x, y, scene);   
                this.addMenuItem('Attack');
                this.addMenuItem('Spell');
                this.addMenuItem('Heal');
            },
            confirm: function() {
                if(this.menuItemIndex === 0) { //Jump to which enemy to attack
                    this.scene.events.emit('SelectEnemies', 'attack');
                }
                else if (this.menuItemIndex === 1) { //Jump to spell selection
                    this.scene.events.emit('SelectSpells');
                }
                else if (this.menuItemIndex === 2) { //Skip turn and Heal.
                    this.scene.events.emit('Enemy', 'heal', 0);
                }
            },
            back: function() { //Just to handle hitting the back button, it just goes to the top option.
                this.menuItems[this.menuItemIndex].deselect();
                this.menuItemIndex = 0;
                this.menuItems[this.menuItemIndex].select();
            }
        });

        var SpellsMenu = new Phaser.Class({
            Extends: Menu,

            initialize: //Spells, obviously.

            function SpellMenu(x, y, scene) {
                Menu.call(this, x, y, scene);
            },
            confirm: function() { 
                if (this.menuItemIndex === 0) {
                    this.scene.events.emit('SelectEnemies', 'magicmissle');
                }
                else if (this.menuItemIndex === 1) {
                    this.scene.events.emit('SelectEnemies', 'firebolt');
                }
                else if (this.menuItemIndex === 2) {
                    this.scene.events.emit('SelectEnemies', 'icespike');
                }
                else if (this.menuItemIndex === 3) {
                    this.scene.events.emit('SelectEnemies', 'shockblast');
                }
                else if (this.menuItemIndex === 4) {
                    this.scene.events.emit('SelectEnemies', 'doombolt');
                }
                else if (this.menuItemIndex === 5) {
                    this.scene.events.emit('SelectEnemies', 'death');
                }
            },
            back: function() { //Go back to Actions
                this.menuItems[this.menuItemIndex].deselect();
                this.scene.events.emit('ActionSelect');
            },
            remap: function(spells) { //This will let us change what spells are available by leveling up.
                this.clear();        
                for(var i = 0; i < spells.length; i++) {
                    var spell = spells[i];
                    this.addMenuItem(spell);            
                }
                this.menuItemIndex = 0;
            }
        });

        var EnemiesMenu = new Phaser.Class({
            Extends: Menu,
            
            initialize:

            function EnemiesMenu(x, y, scene) {
                Menu.call(this, x, y, scene); 
                this.action = 'attack';       //Sets default choice
            },       
            setAction: function(action) {
                this.action = action; //Allows changing the action
            },
            confirm: function() {        
                this.scene.events.emit("Enemy", this.action, this.menuItemIndex); //DO IT TO EM!
            },
            back: function() { //Go back based on chosen action
                this.menuItems[this.menuItemIndex].deselect();
                if (this.action == 'attack') {
                    this.scene.events.emit('ActionSelect');
                }
                else {
                    this.scene.events.emit('SelectSpells');
                }
            },
            remap: function(units) { //Fill the menu with enemies or clear them out if needed.
                this.clear();        
                for(var i = 0; i < units.length; i++) {
                    var unit = units[i];
                    unit.setMenuItem(this.addMenuItem(unit.type));            
                }
                this.menuItemIndex = 0;
            }
        });

        var Message = new Phaser.Class({
            
            Extends: Phaser.GameObjects.Container, //This handles the popup messages the player sees in game.

            initialize:
            function Message(scene, events) {
                Phaser.GameObjects.Container.call(this, scene, 300, 64); //Big container
                var graphics = this.scene.add.graphics(); //With Graphics
                this.add(graphics);
                graphics.lineStyle(1, 0xffffff, 0.8); //So pretty
                graphics.fillStyle(0x031f4c, 0.3);        
                graphics.strokeRect(-150, -30, 300, 100);
                graphics.fillRect(-150, -30, 300, 100);
                this.text = new Phaser.GameObjects.Text(scene, 0, 0, "", { color: '#ffffff', align: 'center', fontSize: 20, wordWrap: { width: 300, useAdvancedWrap: true }});
                this.add(this.text); //Give it some words
                this.text.setOrigin(0.5);        //Center the text
                events.on("Message", this.showMessage, this); //Message event
                this.visible = false; //We don't need to see it if there is no message.
            },
            showMessage: function(text) { //Now display a message
                this.text.setText(text); //Set the text
                this.visible = true; //Show it.
                if(this.hideEvent) //Makes sure we can actually see it more then once.
                    this.hideEvent.remove(false);
                this.hideEvent = this.scene.time.addEvent({ delay: 2000, callback: this.hideMessage, callbackScope: this }); //Time until go away.
            },
            hideMessage: function() { //Go away!
                this.hideEvent = null;
                this.visible = false;
            }
            });
    </script>
</body>
</html>
